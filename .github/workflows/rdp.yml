name: Linux RDP Tunnel using Ngrok

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Update and Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-goodies xrdp wget unzip
        sudo systemctl enable xrdp
        sudo systemctl start xrdp

    - name: Configure RDP User
      run: |
        sudo adduser rdpuser --gecos "RDP User,,," --disabled-password
        echo "rdpuser:rdp123" | sudo chpasswd
        sudo adduser rdpuser sudo

    - name: Download and Install Ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -O ngrok.tgz
        tar -xvzf ngrok.tgz
        sudo mv ngrok /usr/local/bin

    - name: Authenticate Ngrok
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        ngrok config add-authtoken $NGROK_AUTH_TOKEN

    - name: Start Ngrok Tunnel for RDP
      run: |
        nohup ngrok tcp 3389 --log=stdout > ngrok.log 2>&1 &

    - name: Display Ngrok Tunnel Info
      run: |
        sleep 5  # Wait for Ngrok to start
        curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[] | select(.proto=="tcp") | .public_url'

    - name: Keep the Workflow Alive
      run: |
        sleep 43200  # Keep the workflow running for 12 hours
